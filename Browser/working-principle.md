# 浏览器工作原理

## Chrome 多进程架构

![多进程架构图](../img/59.png)

- **浏览器进程**。主要负责界面显示、用户交互、子进程管理，同时提供存储等功能
- **渲染进程**。核心任务是将 HTML、CSS 和 JavaScript 转换为用户可以与之交互的网页，**排版引擎 Blink 和 JavaScript 引擎 V8** 都是运行在该进程中，默认情况下，Chrome 会为每个 Tab 标签创建一个渲染进程。出于安全考虑，渲染进程都是运行在沙箱模式下
- **GPU 进程**
- **网络进程**。主要负责页面的网络资源加载
- **插件进程**。主要是负责插件的运行

Chrome的默认策略是，每个标签对应一个渲染进程。但是如果从一个页面打开了新页面，而新页面和当前页面属于同一站点时，那么新页面会复用父页面的渲染进程。官方把这个默认策略叫 process-per-site-instance

## 输入URL到页面展示过程

![URL 展示完整过程](../img/60.png)

1. 用户输入，判断是搜索内容或者是请求的 URL
2. URL 请求过程
   1. 检查缓存，如果有缓存资源，则直接返回资源到浏览器主进程，如果没有缓存，进入下一步
   2. DNS => HTTP/HTTPS
   3. 接收响应数据
      1. 检查重定向，如果是重定向类的请求则重新导航到响应头中 Location 地址
      2. 响应数据类型 `Content-Type`
3. 准备渲染进程
   1. 通常打开新的页面会使用单独的渲染进程
   2. 如果从一个页面打开了另一个新页面，而新页面和当前页面属于同一站点（根域名和协议相同）的话，那么新页面会复用父页面的渲染进程
4. 提交文档（URL 请求的响应体数据）
  
  提交文档的过程由浏览器主进程发起，渲染进程接收，提交文档确认后，浏览器会更新界面状态
5. 渲染阶段

### 渲染流程

#### 构建 DOM 树

- document 就是 DOM 结构
- DOM 是保存在内存中的树状结构，可以通过 JS 查询和修改

#### 样式计算（Recalculate Style）

1. CSS 文本 => 浏览器理解的 styleSheets (document.styleSheets)
   1. 通过 link 引用的 CSS 文件
   2. `<style>` 标签中的 CSS
   3. 元素的 style 属性内嵌的 CSS
2. 转换样式表中的属性值，使其标准化
3. 计算出 DOM 树中每个节点的具体样式
   1. 继承：每个 DOM 节点都包含有父节点的样式
   2. 层叠：合并来自多个源的属性值

![element 界面](../img/61.png)

#### 布局阶段

1. 创建布局树
   1. 遍历 DOM 树中的所有可见节点，并把这些节点加到布局中
   2. 不可见的节点会被布局树忽略掉
2. 布局计算，计算布局树节点的坐标位置
